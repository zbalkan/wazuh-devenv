import unittest

import internal.logtest as lt


class SysmonForLinuxTests(unittest.TestCase):

    def test_all_sysmon_for_linux_alerts_has_a_matching_alert(self) -> None:
        logs = [
            r'''2026-02-08T18:07:38.895584+02:00 TESTSRV01 sysmon: <Event><System><Provider Name="Linux-Sysmon" Guid="{ff032593-a8d3-4f13-b0d6-01fc615a0f97}"/><EventID>1</EventID><Version>5</Version><Level>4</Level><Task>1</Task><Opcode>0</Opcode><Keywords>0x8000000000000000</Keywords><TimeCreated SystemTime="2026-02-08T16:07:38.895268000Z"/><EventRecordID>4315</EventRecordID><Correlation/><Execution ProcessID="25015" ThreadID="25015"/><Channel>Linux-Sysmon/Operational</Channel><Computer>TESTSRV01</Computer><Security UserId="0"/></System><EventData><Data Name="RuleName">TechniqueID=T1136.001,TechniqueName=Create Account: Local Account</Data><Data Name="UtcTime">2026-02-08 16:06:57.846</Data><Data Name="ProcessGuid">{9d959d53-b4a1-6988-a1e9-a2ea38620000}</Data><Data Name="ProcessId">28029</Data><Data Name="Image">/usr/sbin/useradd</Data><Data Name="FileVersion">-</Data><Data Name="Description">-</Data><Data Name="Product">-</Data><Data Name="Company">-</Data><Data Name="OriginalFileName">-</Data><Data Name="CommandLine">useradd test</Data><Data Name="CurrentDirectory">/home/kevin</Data><Data Name="User">kevin</Data><Data Name="LogonGuid">{9d959d53-0000-0000-e803-000003000000}</Data><Data Name="LogonId">1000</Data><Data Name="TerminalSessionId">4294967295</Data><Data Name="IntegrityLevel">no level</Data><Data Name="Hashes">SHA256=cf687323ab26e097237f5e106bf2a461f699840489ffe97871ca8111a2a220bd</Data><Data Name="ParentProcessGuid">{00000000-0000-0000-0000-000000000000}</Data><Data Name="ParentProcessId">932</Data><Data Name="ParentImage">-</Data><Data Name="ParentCommandLine">-</Data><Data Name="ParentUser">-</Data></EventData></Event>''',
            r'''2026-02-08T18:12:51.162050+02:00 TESTSRV01 sysmon: <Event><System><Provider Name="Linux-Sysmon" Guid="{ff032593-a8d3-4f13-b0d6-01fc615a0f97}"/><EventID>3</EventID><Version>5</Version><Level>4</Level><Task>3</Task><Opcode>0</Opcode><Keywords>0x8000000000000000</Keywords><TimeCreated SystemTime="2026-02-08T16:12:51.161494000Z"/><EventRecordID>4601</EventRecordID><Correlation/><Execution ProcessID="25015" ThreadID="25015"/><Channel>Linux-Sysmon/Operational</Channel><Computer>TESTSRV01</Computer><Security UserId="0"/></System><EventData><Data Name="RuleName">TechniqueID=T1105,TechniqueName=Ingress Tool Transfer</Data><Data Name="UtcTime">2026-02-08 16:11:42.361</Data><Data Name="ProcessGuid">{9d959d53-b5be-6988-8d5e-835bdf5c0000}</Data><Data Name="ProcessId">28985</Data><Data Name="Image">/usr/bin/curl</Data><Data Name="User">kevin</Data><Data Name="Protocol">tcp</Data><Data Name="Initiated">true</Data><Data Name="SourceIsIpv6">false</Data><Data Name="SourceIp">172.26.157.207</Data><Data Name="SourceHostname">-</Data><Data Name="SourcePort">43516</Data><Data Name="SourcePortName">-</Data><Data Name="DestinationIsIpv6">false</Data><Data Name="DestinationIp">13.33.235.126</Data><Data Name="DestinationHostname">-</Data><Data Name="DestinationPort">80</Data><Data Name="DestinationPortName">-</Data></EventData></Event>''',
            r'''2026-02-08T18:05:59.458536+02:00 TESTSRV01 sysmon: <Event><System><Provider Name="Linux-Sysmon" Guid="{ff032593-a8d3-4f13-b0d6-01fc615a0f97}"/><EventID>5</EventID><Version>3</Version><Level>4</Level><Task>5</Task><Opcode>0</Opcode><Keywords>0x8000000000000000</Keywords><TimeCreated SystemTime="2026-02-08T16:05:59.458428000Z"/><EventRecordID>4034</EventRecordID><Correlation/><Execution ProcessID="25015" ThreadID="25015"/><Channel>Linux-Sysmon/Operational</Channel><Computer>TESTSRV01</Computer><Security UserId="0"/></System><EventData><Data Name="RuleName">-</Data><Data Name="UtcTime">2026-02-08 16:05:27.207</Data><Data Name="ProcessGuid">{9d959d53-b447-6988-3153-84dd10630000}</Data><Data Name="ProcessId">27744</Data><Data Name="Image">/usr/bin/grep</Data><Data Name="User">kevin</Data></EventData></Event>'''
        ]

        responses = lt.send_multiple_logs(logs)

        for response in responses:
            self.assertEqual(response.status, lt.LogtestStatus.RuleMatch)

    def test_all_sysmon_for_linux_alerts_has_group(self) -> None:
        logs = [
            r'''2026-02-08T18:07:38.895584+02:00 TESTSRV01 sysmon: <Event><System><Provider Name="Linux-Sysmon" Guid="{ff032593-a8d3-4f13-b0d6-01fc615a0f97}"/><EventID>1</EventID><Version>5</Version><Level>4</Level><Task>1</Task><Opcode>0</Opcode><Keywords>0x8000000000000000</Keywords><TimeCreated SystemTime="2026-02-08T16:07:38.895268000Z"/><EventRecordID>4315</EventRecordID><Correlation/><Execution ProcessID="25015" ThreadID="25015"/><Channel>Linux-Sysmon/Operational</Channel><Computer>TESTSRV01</Computer><Security UserId="0"/></System><EventData><Data Name="RuleName">TechniqueID=T1136.001,TechniqueName=Create Account: Local Account</Data><Data Name="UtcTime">2026-02-08 16:06:57.846</Data><Data Name="ProcessGuid">{9d959d53-b4a1-6988-a1e9-a2ea38620000}</Data><Data Name="ProcessId">28029</Data><Data Name="Image">/usr/sbin/useradd</Data><Data Name="FileVersion">-</Data><Data Name="Description">-</Data><Data Name="Product">-</Data><Data Name="Company">-</Data><Data Name="OriginalFileName">-</Data><Data Name="CommandLine">useradd test</Data><Data Name="CurrentDirectory">/home/kevin</Data><Data Name="User">kevin</Data><Data Name="LogonGuid">{9d959d53-0000-0000-e803-000003000000}</Data><Data Name="LogonId">1000</Data><Data Name="TerminalSessionId">4294967295</Data><Data Name="IntegrityLevel">no level</Data><Data Name="Hashes">SHA256=cf687323ab26e097237f5e106bf2a461f699840489ffe97871ca8111a2a220bd</Data><Data Name="ParentProcessGuid">{00000000-0000-0000-0000-000000000000}</Data><Data Name="ParentProcessId">932</Data><Data Name="ParentImage">-</Data><Data Name="ParentCommandLine">-</Data><Data Name="ParentUser">-</Data></EventData></Event>''',
            r'''2026-02-08T18:12:51.162050+02:00 TESTSRV01 sysmon: <Event><System><Provider Name="Linux-Sysmon" Guid="{ff032593-a8d3-4f13-b0d6-01fc615a0f97}"/><EventID>3</EventID><Version>5</Version><Level>4</Level><Task>3</Task><Opcode>0</Opcode><Keywords>0x8000000000000000</Keywords><TimeCreated SystemTime="2026-02-08T16:12:51.161494000Z"/><EventRecordID>4601</EventRecordID><Correlation/><Execution ProcessID="25015" ThreadID="25015"/><Channel>Linux-Sysmon/Operational</Channel><Computer>TESTSRV01</Computer><Security UserId="0"/></System><EventData><Data Name="RuleName">TechniqueID=T1105,TechniqueName=Ingress Tool Transfer</Data><Data Name="UtcTime">2026-02-08 16:11:42.361</Data><Data Name="ProcessGuid">{9d959d53-b5be-6988-8d5e-835bdf5c0000}</Data><Data Name="ProcessId">28985</Data><Data Name="Image">/usr/bin/curl</Data><Data Name="User">kevin</Data><Data Name="Protocol">tcp</Data><Data Name="Initiated">true</Data><Data Name="SourceIsIpv6">false</Data><Data Name="SourceIp">172.26.157.207</Data><Data Name="SourceHostname">-</Data><Data Name="SourcePort">43516</Data><Data Name="SourcePortName">-</Data><Data Name="DestinationIsIpv6">false</Data><Data Name="DestinationIp">13.33.235.126</Data><Data Name="DestinationHostname">-</Data><Data Name="DestinationPort">80</Data><Data Name="DestinationPortName">-</Data></EventData></Event>''',
            r'''2026-02-08T18:05:59.458536+02:00 TESTSRV01 sysmon: <Event><System><Provider Name="Linux-Sysmon" Guid="{ff032593-a8d3-4f13-b0d6-01fc615a0f97}"/><EventID>5</EventID><Version>3</Version><Level>4</Level><Task>5</Task><Opcode>0</Opcode><Keywords>0x8000000000000000</Keywords><TimeCreated SystemTime="2026-02-08T16:05:59.458428000Z"/><EventRecordID>4034</EventRecordID><Correlation/><Execution ProcessID="25015" ThreadID="25015"/><Channel>Linux-Sysmon/Operational</Channel><Computer>TESTSRV01</Computer><Security UserId="0"/></System><EventData><Data Name="RuleName">-</Data><Data Name="UtcTime">2026-02-08 16:05:27.207</Data><Data Name="ProcessGuid">{9d959d53-b447-6988-3153-84dd10630000}</Data><Data Name="ProcessId">27744</Data><Data Name="Image">/usr/bin/grep</Data><Data Name="User">kevin</Data></EventData></Event>'''
        ]

        responses = lt.send_multiple_logs(logs)

        for response in responses:
            self.assertIsNotNone(response.rule_groups)
            self.assertIn('sysmon-linux', response.rule_groups)

    def test_eventid_1_must_trigger_level_3_alert(self) -> None:
        log = r'''2026-02-08T18:07:38.895584+02:00 TESTSRV01 sysmon: <Event><System><Provider Name="Linux-Sysmon" Guid="{ff032593-a8d3-4f13-b0d6-01fc615a0f97}"/><EventID>1</EventID><Version>5</Version><Level>4</Level><Task>1</Task><Opcode>0</Opcode><Keywords>0x8000000000000000</Keywords><TimeCreated SystemTime="2026-02-08T16:07:38.895268000Z"/><EventRecordID>4315</EventRecordID><Correlation/><Execution ProcessID="25015" ThreadID="25015"/><Channel>Linux-Sysmon/Operational</Channel><Computer>TESTSRV01</Computer><Security UserId="0"/></System><EventData><Data Name="RuleName">TechniqueID=T1136.001,TechniqueName=Create Account: Local Account</Data><Data Name="UtcTime">2026-02-08 16:06:57.846</Data><Data Name="ProcessGuid">{9d959d53-b4a1-6988-a1e9-a2ea38620000}</Data><Data Name="ProcessId">28029</Data><Data Name="Image">/usr/sbin/useradd</Data><Data Name="FileVersion">-</Data><Data Name="Description">-</Data><Data Name="Product">-</Data><Data Name="Company">-</Data><Data Name="OriginalFileName">-</Data><Data Name="CommandLine">useradd test</Data><Data Name="CurrentDirectory">/home/kevin</Data><Data Name="User">kevin</Data><Data Name="LogonGuid">{9d959d53-0000-0000-e803-000003000000}</Data><Data Name="LogonId">1000</Data><Data Name="TerminalSessionId">4294967295</Data><Data Name="IntegrityLevel">no level</Data><Data Name="Hashes">SHA256=cf687323ab26e097237f5e106bf2a461f699840489ffe97871ca8111a2a220bd</Data><Data Name="ParentProcessGuid">{00000000-0000-0000-0000-000000000000}</Data><Data Name="ParentProcessId">932</Data><Data Name="ParentImage">-</Data><Data Name="ParentCommandLine">-</Data><Data Name="ParentUser">-</Data></EventData></Event>'''

        response = lt.send_log(log)

        self.assertEqual(response.rule_level, 3)

    def test_eventid_3_must_trigger_level_3_alert(self) -> None:
        log = r'''2026-02-08T18:12:51.162050+02:00 TESTSRV01 sysmon: <Event><System><Provider Name="Linux-Sysmon" Guid="{ff032593-a8d3-4f13-b0d6-01fc615a0f97}"/><EventID>3</EventID><Version>5</Version><Level>4</Level><Task>3</Task><Opcode>0</Opcode><Keywords>0x8000000000000000</Keywords><TimeCreated SystemTime="2026-02-08T16:12:51.161494000Z"/><EventRecordID>4601</EventRecordID><Correlation/><Execution ProcessID="25015" ThreadID="25015"/><Channel>Linux-Sysmon/Operational</Channel><Computer>TESTSRV01</Computer><Security UserId="0"/></System><EventData><Data Name="RuleName">TechniqueID=T1105,TechniqueName=Ingress Tool Transfer</Data><Data Name="UtcTime">2026-02-08 16:11:42.361</Data><Data Name="ProcessGuid">{9d959d53-b5be-6988-8d5e-835bdf5c0000}</Data><Data Name="ProcessId">28985</Data><Data Name="Image">/usr/bin/curl</Data><Data Name="User">kevin</Data><Data Name="Protocol">tcp</Data><Data Name="Initiated">true</Data><Data Name="SourceIsIpv6">false</Data><Data Name="SourceIp">172.26.157.207</Data><Data Name="SourceHostname">-</Data><Data Name="SourcePort">43516</Data><Data Name="SourcePortName">-</Data><Data Name="DestinationIsIpv6">false</Data><Data Name="DestinationIp">13.33.235.126</Data><Data Name="DestinationHostname">-</Data><Data Name="DestinationPort">80</Data><Data Name="DestinationPortName">-</Data></EventData></Event>'''
        response = lt.send_log(log)

        self.assertEqual(response.rule_level, 3)

    def test_eventid_5_must_trigger_level_3_alert(self) -> None:
        log = r'''2026-02-08T18:05:59.458536+02:00 TESTSRV01 sysmon: <Event><System><Provider Name="Linux-Sysmon" Guid="{ff032593-a8d3-4f13-b0d6-01fc615a0f97}"/><EventID>5</EventID><Version>3</Version><Level>4</Level><Task>5</Task><Opcode>0</Opcode><Keywords>0x8000000000000000</Keywords><TimeCreated SystemTime="2026-02-08T16:05:59.458428000Z"/><EventRecordID>4034</EventRecordID><Correlation/><Execution ProcessID="25015" ThreadID="25015"/><Channel>Linux-Sysmon/Operational</Channel><Computer>TESTSRV01</Computer><Security UserId="0"/></System><EventData><Data Name="RuleName">-</Data><Data Name="UtcTime">2026-02-08 16:05:27.207</Data><Data Name="ProcessGuid">{9d959d53-b447-6988-3153-84dd10630000}</Data><Data Name="ProcessId">27744</Data><Data Name="Image">/usr/bin/grep</Data><Data Name="User">kevin</Data></EventData></Event>'''

        response = lt.send_log(log)

        self.assertEqual(response.rule_level, 3)

    def test_eventid_1_must_have_commandline_args(self) -> None:
        log = r'''2026-02-08T18:07:38.895584+02:00 TESTSRV01 sysmon: <Event><System><Provider Name="Linux-Sysmon" Guid="{ff032593-a8d3-4f13-b0d6-01fc615a0f97}"/><EventID>1</EventID><Version>5</Version><Level>4</Level><Task>1</Task><Opcode>0</Opcode><Keywords>0x8000000000000000</Keywords><TimeCreated SystemTime="2026-02-08T16:07:38.895268000Z"/><EventRecordID>4315</EventRecordID><Correlation/><Execution ProcessID="25015" ThreadID="25015"/><Channel>Linux-Sysmon/Operational</Channel><Computer>TESTSRV01</Computer><Security UserId="0"/></System><EventData><Data Name="RuleName">TechniqueID=T1136.001,TechniqueName=Create Account: Local Account</Data><Data Name="UtcTime">2026-02-08 16:06:57.846</Data><Data Name="ProcessGuid">{9d959d53-b4a1-6988-a1e9-a2ea38620000}</Data><Data Name="ProcessId">28029</Data><Data Name="Image">/usr/sbin/useradd</Data><Data Name="FileVersion">-</Data><Data Name="Description">-</Data><Data Name="Product">-</Data><Data Name="Company">-</Data><Data Name="OriginalFileName">-</Data><Data Name="CommandLine">useradd test</Data><Data Name="CurrentDirectory">/home/kevin</Data><Data Name="User">kevin</Data><Data Name="LogonGuid">{9d959d53-0000-0000-e803-000003000000}</Data><Data Name="LogonId">1000</Data><Data Name="TerminalSessionId">4294967295</Data><Data Name="IntegrityLevel">no level</Data><Data Name="Hashes">SHA256=cf687323ab26e097237f5e106bf2a461f699840489ffe97871ca8111a2a220bd</Data><Data Name="ParentProcessGuid">{00000000-0000-0000-0000-000000000000}</Data><Data Name="ParentProcessId">932</Data><Data Name="ParentImage">-</Data><Data Name="ParentCommandLine">-</Data><Data Name="ParentUser">-</Data></EventData></Event>'''

        response = lt.send_log(log)

        self.assertIn('eventData.commandLine', response.get_dynamic_field_names())
